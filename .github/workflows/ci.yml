# CI Pipeline - Runs before PR can merge
# Checks: Health, Migration, Security Lint

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Job 1: Health Check
  health-check:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: nexususer
          POSTGRES_PASSWORD: nexuspass
          POSTGRES_DB: nexusapi
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Wait for PostgreSQL
        run: |
          sleep 10

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql+asyncpg://nexususer:nexuspass@localhost:5432/nexusapi
          REDIS_URL: redis://localhost:6379
        run: |
          alembic upgrade head

      - name: Start API and check health
        env:
          DATABASE_URL: postgresql+asyncpg://nexususer:nexuspass@localhost:5432/nexusapi
          REDIS_URL: redis://localhost:6379
        run: |
          timeout 30 uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 10
          curl -f http://localhost:8000/health || exit 1

  # Job 2: Migration Check
  migration-check:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: nexususer
          POSTGRES_PASSWORD: nexuspass
          POSTGRES_DB: nexusapi
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Wait for PostgreSQL
        run: |
          sleep 10

      - name: Run migrations
        env:
          DATABASE_URL: postgresql+asyncpg://nexususer:nexuspass@localhost:5432/nexusapi
        run: |
          alembic upgrade head

      - name: Verify migrations work
        run: |
          alembic current
          alembic history

  # Job 3: Security Lint (Bandit)
  security-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install bandit
        run: |
          pip install bandit

      - name: Run bandit security scan
        run: |
          bandit -r app/ -f json -o bandit-report.json || true

      - name: Check for hardcoded secrets
        run: |
          # Check for actual hardcoded secrets (not settings references)
          # Exclude settings.py and .env files
          grep -r "password\s*=\s*['\"][^$]" app/ --include="*.py" | grep -v "settings\." || echo "No hardcoded passwords"
          grep -r "secret\s*=\s*['\"][^$]" app/ --include="*.py" | grep -v "settings\." | grep -v "webhook_secret" || echo "No hardcoded secrets"
          grep -r "JWT_SECRET_KEY\s*=\s*['\"]" app/ --include="*.py" | grep -v "settings\." || echo "No hardcoded JWT secrets"
